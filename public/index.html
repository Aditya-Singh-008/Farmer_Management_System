<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farmer Dashboard</title>
    <link rel="stylesheet" href="src/css/index.css">
    <link rel="stylesheet" href="src/css/sidebar.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome with fallback CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" 
          onerror="this.onerror=null;this.href='https://use.fontawesome.com/releases/v6.4.0/css/all.css'">
    <link rel="stylesheet" href="src/css/theme.css">
</head>
<body class="light-mode">
    <script>
        window.__SUPABASE_CONFIG__ = {
            url: 'https://bmdypirsqwhghrvbhqoy.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZHlwaXJzcXdoZ2hydmJocW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MjE5NzcsImV4cCI6MjA3NTM5Nzk3N30.2Mea6l7pn1l-qw28Nxk_m2weMajWlbca0M-ZybMs2xg'
        };
        window.__ENV = {
            EDGE_FUNCTION_BASE_URL: 'https://bmdypirsqwhghrvbhqoy.functions.supabase.co',
            SERVICE_ROLE_TOKEN: '<eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZHlwaXJzcXdoZ2hydmJocW95Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTgyMTk3NywiZXhwIjoyMDc1Mzk3OTc3fQ.NpfC1SI0-N6g68KoPt9hNhCSK8pCytamQ6khJ7qCYcc>'
        };
    </script>
    <script>
        window.OPENWEATHER_API_KEY = 'fc309c7b44cc13aeedc0d03709c7c28d';
    </script>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar Container -->
    <div id="sidebar-container">
        <!-- Sidebar will be loaded here by JavaScript -->
    </div>

    <!-- Main Content Wrapper - ONLY ONE! -->
    <main class="main-content">
        <!-- Top Navbar -->
        <header class="navbar">
            <div class="navbar-content">
                <div class="greeting">
                    <!-- dynamic greeting -->
                    <h1 id="greeting">Good Morning, Farmer</h1>
                    <p id="greeting-sub">Here's your farm overview for today</p>
                </div>
                
                <div class="navbar-actions">
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="action-btn" id="navigateFieldsBtn" aria-label="Add Farm">
                            <i class="fas fa-plus" aria-hidden="true"></i> Add Farm
                        </button>
                        <button class="action-btn" id="navigateCropsBtn" aria-label="Add Crop">
                            <i class="fas fa-seedling" aria-hidden="true"></i> Add Crop
                        </button>
                    </div>
                    
                    <!-- Profile -->
                    <div class="user-actions">
                        <!-- user menu: button toggles dropdown -->
                        <div class="user-profile" id="user-profile-wrapper">
                            <button id="userMenuBtn" class="user-button" aria-haspopup="true" aria-expanded="false" aria-controls="userMenu" title="User menu">
                                <div class="avatar" id="avatar" aria-hidden="true">FJ</div>
                                <span class="user-name" id="user-name">Farmer</span>
                                <i class="fas fa-caret-down" aria-hidden="true"></i>
                            </button>

                            <div id="userMenu" class="user-menu hidden" role="menu" aria-labelledby="userMenuBtn">
                                <button id="openProfileBtn" class="menu-item" role="menuitem">Profile</button>
                                <button id="logoutBtn" class="menu-item" role="menuitem">Log out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="demoNotice" class="demo-notice hidden" role="status" aria-live="polite">
            Demo data is currently displayed. Connect your Supabase project to see live stats.
        </div>

        <!-- Main Dashboard Content -->
        <div class="dashboard">
            <!-- Weather Stats Cards -->
            <div class="stats-grid">
                <!-- Soil Moisture Card -->
                <div class="stat-card card-hover">
                    <div class="card-header">
                        <div>
                            <p class="card-label">Soil Moisture</p>
                            <h3 class="card-value" id="soilMoistureValue">--</h3>
                        </div>
                        <div class="card-icon soil-icon">
                            <i class="fas fa-tint" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="card-status">
                        <span class="status-badge normal" id="soilStatus">--</span>
                    </div>
                </div>

                <!-- Air Temperature Card -->
                <div class="stat-card card-hover">
                    <div class="card-header">
                        <div>
                            <p class="card-label">Air Temperature</p>
                            <h3 class="card-value" id="airTempValue">--</h3>
                        </div>
                        <div class="card-icon temp-icon">
                            <i class="fas fa-thermometer-half" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="card-status">
                        <span class="status-badge optimal" id="tempStatus">--</span>
                    </div>
                </div>

                <!-- Wind Speed Card -->
                <div class="stat-card card-hover">
                    <div class="card-header">
                        <div>
                            <p class="card-label">Wind Speed</p>
                            <h3 class="card-value" id="windSpeedValue">--</h3>
                        </div>
                        <div class="card-icon wind-icon">
                            <i class="fas fa-wind" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="card-status">
                        <span class="status-badge moderate" id="windStatus">--</span>
                    </div>
                </div>

                <!-- Rainfall Probability Card -->
                <div class="stat-card card-hover">
                    <div class="card-header">
                        <div>
                            <p class="card-label">Rainfall Probability</p>
                            <h3 class="card-value" id="rainfallValue">--</h3>
                        </div>
                        <div class="card-icon rain-icon">
                            <i class="fas fa-cloud-rain" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="card-status">
                        <span class="status-badge low" id="rainStatus">--</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <!-- Tasks & Crop Production -->
            <div class="content-grid">
                <!-- Upcoming Tasks -->
                <div class="tasks-card">
                    <div class="card-header">
                        <h2>Upcoming Tasks</h2>
                        <span id="tasksCount" class="badge subtle-badge" aria-live="polite"></span>
                    </div>
                    <div class="tasks-list" id="tasks-list">
                        <!-- tasks will be rendered here -->
                    </div>
                </div>

                <!-- Current Crop Production -->
                <div class="crops-card">
                    <h2>Current Crop Production</h2>
                    <div class="crops-grid" id="crops-grid">
                        <!-- crops will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Profile modal (hidden) -->
    <div id="profileModal" class="modal hidden profile-modal" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="profileModalTitle">Profile Details</h2>
                    <button type="button" id="closeProfileModal" class="modal-close" aria-label="Close profile modal">&times;</button>
                </div>
                <p id="profileMessage" class="modal-message" aria-live="polite"></p>

                <div id="profileSummary" class="profile-summary">
                    <div class="summary-grid" id="profileSummaryGrid"></div>
                    <p id="profileMissing" class="summary-missing" aria-live="polite"></p>
                    <button type="button" id="profileEditBtn" class="action-btn secondary">Update profile details</button>
                </div>

                <div id="profileEditPanel" class="profile-edit-panel hidden">
                    <form id="profileForm" class="profile-form-grid">
                        <!-- fields from screenshot -->
                <input type="hidden" id="profile_id" name="profile_id">
                <input type="hidden" id="user_id" name="user_id">
                <input type="hidden" id="auth_user_id" name="auth_user_id">
                <input type="hidden" id="app_user_id" name="app_user_id">

                <label>First name
                    <input type="text" id="first_name" name="first_name" required>
                </label>
                <label>Last name
                    <input type="text" id="last_name" name="last_name" required>
                </label>
                <label>Phone number
                    <input type="tel" id="phone_number" name="phone_number" maxlength="15">
                </label>
                <label>Address line 1
                    <input type="text" id="address_line1" name="address_line1">
                </label>
                <label>Address line 2
                    <input type="text" id="address_line2" name="address_line2">
                </label>
                <label>City
                    <input type="text" id="city" name="city">
                </label>
                <label>State
                    <input type="text" id="state" name="state">
                </label>
                <label>Postal code
                    <input type="text" id="postal_code" name="postal_code" maxlength="15">
                </label>
                <label>Country
                    <input type="text" id="country" name="country">
                </label>
                <label>Date of birth
                    <input type="date" id="dob" name="dob">
                </label>
                <label>Gender
                    <select id="gender" name="gender">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </label>
                <label>Profile picture (URL)
                    <input type="url" id="profile_picture" name="profile_picture" placeholder="https://...">
                </label>

                <div class="modal-actions">
                    <button type="button" id="cancelProfileBtn">Cancel</button>
                    <button type="submit" id="saveProfileBtn">Save profile</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addTaskModal" class="modal task-modal hidden" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
        <div class="task-modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="taskModalTitle">Add a task</h2>
                    <p class="modal-subtitle">Assign chores to specific fields so you always know what needs attention.</p>
                </div>
                <button type="button" id="closeTaskModal" class="modal-close" aria-label="Close task modal">&times;</button>
            </div>
            <form id="taskForm" class="task-modal-form">
                <label>
                    Task title
                    <input type="text" name="title" id="taskTitleInput" required placeholder="e.g., Irrigation check">
                </label>
                <div class="task-form-grid">
                    <label>
                        Field / location
                        <div class="task-field-select">
                            <select name="field" id="taskFieldSelect" required aria-label="Choose field for the task"></select>
                            <div id="taskFieldCustomWrap" class="task-field-custom hidden">
                                <input type="text" id="taskCustomField" name="customField" placeholder="Enter field name">
                            </div>
                        </div>
                        <small class="form-hint">Pick an existing field or add a new one.</small>
                    </label>
                    <label>
                        Due date
                        <input type="date" name="due" id="taskDueInput">
                    </label>
                </div>
                <label>
                    Notes (optional)
                    <textarea name="notes" id="taskNotesInput" rows="3" placeholder="Add instructions or reminders"></textarea>
                </label>
                <div class="modal-actions">
                    <button type="button" class="secondary" id="cancelTaskBtn">Cancel</button>
                    <button type="submit" class="primary">Save task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- scripts: load Supabase client first, then app API helpers -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="src/js/supabase.js"></script>
    <script src="src/js/api.js"></script>
    <script src="src/js/fontawesome-fallback.js"></script>
    <script src="src/js/index.js"></script>
    <script src="src/js/user-ui.js"></script>
    <script src="src/js/utils.js"></script>
    <script src="src/js/main.js"></script>
    <script src="src/js/load-sidebar.js"></script>
    <script src="src/js/theme.js"></script>
    <script src="src/js/sidebar.js"></script>
    <script src="src/js/profile-modal.js"></script>

    <!-- Weather helpers; dashboard data is rendered via src/js/index.js to avoid duplicate calls -->
    <script>
    function setWeatherPlaceholders() {
        const valueTargets = ['soilMoistureValue', 'airTempValue', 'windSpeedValue', 'rainfallValue'];
        valueTargets.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });
        const statusTargets = ['soilStatus', 'tempStatus', 'windStatus', 'rainStatus'];
        statusTargets.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Loading';
        });
    }

    function setWeatherErrorState() {
        const valueTargets = ['soilMoistureValue', 'airTempValue', 'windSpeedValue', 'rainfallValue'];
        valueTargets.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });
        const statusTargets = ['soilStatus', 'tempStatus', 'windStatus', 'rainStatus'];
        statusTargets.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Unavailable';
        });
    }
    function renderWeatherReadings({ humidity, temperature, windSpeed, rainChance }) {
        const normalize = (value) => {
            if (value === null || typeof value === 'undefined') return null;
            if (typeof value === 'string') {
                const parsedString = parseFloat(value);
                if (!Number.isNaN(parsedString)) {
                    value = parsedString;
                }
            }
            const parsed = Number(value);
            return Number.isFinite(parsed) ? Math.round(parsed) : null;
        };

        const soilValue = normalize(humidity);
        const tempValue = normalize(temperature);
        const windValue = normalize(windSpeed);
        const rainValue = normalize(rainChance);

        const soilEl = document.getElementById('soilMoistureValue');
        if (soilEl) soilEl.textContent = soilValue !== null ? `${soilValue}%` : '--';

        const airEl = document.getElementById('airTempValue');
        if (airEl) airEl.textContent = tempValue !== null ? `${tempValue}\u00B0C` : '--';

        const windEl = document.getElementById('windSpeedValue');
        if (windEl) windEl.textContent = windValue !== null ? `${windValue} km/h` : '--';

        const rainEl = document.getElementById('rainfallValue');
        if (rainEl) rainEl.textContent = rainValue !== null ? `${rainValue}%` : '--';

        const soilStatus = document.getElementById('soilStatus');
        if (soilStatus) {
            soilStatus.textContent =
                soilValue === null ? 'Unknown' : soilValue > 75 ? 'Saturated' : soilValue < 35 ? 'Dry' : 'Normal';
        }

        const tempStatus = document.getElementById('tempStatus');
        if (tempStatus) {
            tempStatus.textContent =
                tempValue === null ? 'Unknown' : tempValue > 32 ? 'Hot' : tempValue < 15 ? 'Cool' : 'Optimal';
        }

        const windStatus = document.getElementById('windStatus');
        if (windStatus) {
            windStatus.textContent =
                windValue === null ? 'Unknown' : windValue > 25 ? 'Breezy' : windValue > 10 ? 'Moderate' : 'Calm';
        }

        const rainStatus = document.getElementById('rainStatus');
        if (rainStatus) {
            rainStatus.textContent =
                rainValue === null ? 'Unknown' : rainValue > 50 ? 'High' : rainValue > 20 ? 'Moderate' : 'Low';
        }
    }

    function applyWeatherFromDataset(dataset = {}) {
        if (!dataset) {
            setWeatherErrorState();
            return;
        }

        renderWeatherReadings({
            humidity: dataset.soil_moisture ?? dataset.humidity ?? null,
            temperature: dataset.temperature ?? dataset.temp ?? null,
            windSpeed: dataset.wind_speed ?? dataset.windSpeed ?? null,
            rainChance:
                dataset.rainfall_probability ??
                dataset.rain_probability ??
                dataset.rain_chance ??
                dataset.precip_probability ??
                null
        });
    }

    async function updateWeatherFromCity(city, fallbackWeather = null) {
        if (!city) {
            if (fallbackWeather) {
                applyWeatherFromDataset(fallbackWeather);
            }
            return;
        }

        const apiKey = window.OPENWEATHER_API_KEY;
        if (!apiKey || apiKey.includes('YOUR_')) {
            console.warn('OpenWeather API key missing or placeholder, using fallback weather.');
            if (fallbackWeather) {
                applyWeatherFromDataset(fallbackWeather);
            } else {
                setWeatherErrorState();
            }
            return;
        }

        try {
            const response = await fetch(
                `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`
            );
            if (!response.ok) {
                throw new Error(`OpenWeather responded ${response.status}`);
            }

            const weather = await response.json();
            renderWeatherReadings({
                humidity: weather.main?.humidity ?? null,
                temperature: weather.main?.temp ?? null,
                windSpeed: weather.wind?.speed != null ? weather.wind.speed * 3.6 : null,
                rainChance:
                    typeof weather.clouds?.all === 'number'
                        ? weather.clouds.all
                        : weather.rain?.['1h'] != null
                        ? Math.min(100, Math.round(weather.rain['1h'] * 100))
                        : null
            });
        } catch (error) {
            console.warn('Unable to fetch OpenWeather data', error);
            if (fallbackWeather) {
                applyWeatherFromDataset(fallbackWeather);
            } else {
                setWeatherErrorState();
            }
        }
    }
    </script>
    <script>
        // Override tasks/crops tiles with richer info and counts
        document.addEventListener('DOMContentLoaded', () => {
            refreshTasksAndCrops();
        });

        async function refreshTasksAndCrops() {
            await Promise.all([renderTasksTile(), renderCropsTile()]);
        }

        async function renderTasksTile() {
            const container = document.getElementById('tasks-list');
            if (!container) return;
            const countEl = document.getElementById('tasksCount');
            let tasks = [];
            try {
                const res = window.FarmerAPI?.getTasks ? await window.FarmerAPI.getTasks(20) : null;
                if (res?.success && Array.isArray(res.data)) {
                    tasks = res.data;
                }
            } catch (err) {
                console.warn('refresh tasks tile failed', err);
            }
            if (tasks.length === 0) {
                container.innerHTML = `<div class="empty-state">No upcoming tasks.</div>`;
                if (countEl) countEl.textContent = 'No tasks';
                return;
            }
            if (countEl) countEl.textContent = `${tasks.length} task${tasks.length === 1 ? '' : 's'}`;
            container.innerHTML = '';
            tasks.forEach((t) => {
                const due = t.due_date || t.due || t.dueDate || 'TBD';
                const status = (t.status || 'scheduled').toLowerCase();
                const title = t.title || t.name || 'Task';
                const field = t.field || t.field_name || 'Field';
                const item = document.createElement('div');
                item.className = 'task-item';
                item.innerHTML = `
                    <div class="task-info">
                        <div class="task-icon watering" aria-hidden="true"><i class="fas fa-tint" aria-hidden="true"></i></div>
                        <div>
                            <h3 class="task-title">${title}</h3>
                            <p class="task-location">${field}</p>
                        </div>
                    </div>
                    <div class="task-meta">
                        <p class="task-due">Due: ${due}</p>
                        <span class="status-badge ${status}">${status}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        async function renderCropsTile() {
            const container = document.getElementById('crops-grid');
            if (!container) return;
            let crops = [];
            try {
                const res = window.FarmerAPI?.getCrops ? await window.FarmerAPI.getCrops(12) : null;
                if (res?.success && Array.isArray(res.data)) {
                    crops = res.data;
                }
            } catch (err) {
                console.warn('refresh crops tile failed', err);
            }
            if (crops.length === 0) {
                container.innerHTML = `<div class="empty-state">No crop data available.</div>`;
                return;
            }
            container.innerHTML = '';
            crops.forEach((c) => {
                const name = c.crop_name || c.name || 'Crop';
                const status = c.status || 'active';
                const harvest = c.expected_harvest || c.harvest_date || c.expected_harvest_date || 'Not set';
                const trendClass = (c.trend === 'down' ? 'neutral' : 'positive');
                const areaVal = Number(c.area || c.field_area || 0);
                const estimated = c.yield || c.crop_yield || c.expected_yield || c.estimated_yield;
                const yieldVal = estimated
                    ? `${estimated}`
                    : areaVal
                        ? `${(areaVal * 2.5).toFixed(1)}`
                        : '--';
                const node = document.createElement('div');
                node.className = `crop-item ${(c.type || name).toLowerCase()}`;
                node.innerHTML = `
                    <div class="crop-icon" aria-hidden="true"><i class="${c.icon || 'fas fa-seedling'}" aria-hidden="true"></i></div>
                    <h3 class="crop-name">${name}</h3>
                    <p class="crop-yield">${yieldVal}</p>
                    <p class="crop-status"><strong>Status:</strong> ${status}</p>
                    <p class="crop-harvest"><strong>Harvest:</strong> ${harvest}</p>
                    <div class="crop-trend">
                        <span class="trend-badge ${trendClass}">${c.change ? (c.change+'%') : ''}</span>
                    </div>
                `;
                container.appendChild(node);
            });
        }
    </script>

</body>
</html>
